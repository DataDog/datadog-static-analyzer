use crate::model::common::Language;

pub const PROTOBUF_HEADER: &str = "Generated by the protocol buffer compiler.  DO NOT EDIT!";
pub const THRIFT_HEADER: &str = "Autogenerated by Thrift Compiler";

/// Returns if a file is generated or not based on a few heuristics.
/// Some heuristics are based on these sources
///  - https://github.com/github-linguist/linguist/blob/master/lib/linguist/generated.rb
pub fn is_generated_file(content: &str, language: &Language) -> bool {
    match language {
        Language::Go => {
            content.contains("Code generated by")
                | content.contains(PROTOBUF_HEADER)
                | content.contains(THRIFT_HEADER)
        }
        Language::Java => {
            content.contains("generated by the protocol buffer compiler")
                | content.contains(PROTOBUF_HEADER)
                | content.contains(THRIFT_HEADER)
        }
        Language::JavaScript => {
            content.contains("Generated by PEG.js")
                | content.contains("GENERATED CODE -- DO NOT EDIT!")
                | content.contains(THRIFT_HEADER)
        }
        Language::Python => {
            content.contains("Generated protocol buffer code")
                | content.contains("Code generated by")
                | content.contains(PROTOBUF_HEADER)
                | content.contains(THRIFT_HEADER)
        }
        Language::Ruby => content.contains(PROTOBUF_HEADER) | content.contains(THRIFT_HEADER),
        Language::TypeScript => {
            content.contains("Generated by PEG.js")
                | content.contains("GENERATED CODE -- DO NOT EDIT!")
                | content.contains(THRIFT_HEADER)
        }
        _ => false,
    }
}

#[cfg(test)]
mod tests {
    use crate::analysis::generated_content::is_generated_file;
    use crate::model::common::Language;

    #[test]
    fn test_is_generated_file_java() {
        assert!(!is_generated_file(&"class Foobar", &Language::Java));
        assert!(is_generated_file(
            &"// generated by the protocol buffer compiler\n class Foobar{}",
            &Language::Java
        ));
    }

    #[test]
    fn test_is_generated_file_go() {
        assert!(!is_generated_file(&"fn func(){}", &Language::Go));
        assert!(is_generated_file(
            &"// Code generated by MockGen\nfn func(){}",
            &Language::Go
        ));
    }

    #[test]
    fn test_is_generated_file_python() {
        assert!(!is_generated_file(
            &"def foo():\n  pass\n",
            &Language::Python
        ));
        assert!(is_generated_file(
            &"# Code generated by some tool\ndef foo():\n  pass\n",
            &Language::Go
        ));
    }

    #[test]
    fn test_is_generated_file_javascript() {
        assert!(!is_generated_file(
            &"function smtg(){}",
            &Language::JavaScript
        ));
        assert!(is_generated_file(
            &"// GENERATED CODE -- DO NOT EDIT!\nfunction smtg(){}",
            &Language::JavaScript
        ));
    }

    #[test]
    fn test_is_generated_file_typescript() {
        assert!(!is_generated_file(
            &"function smtg(){}",
            &Language::TypeScript
        ));
        assert!(is_generated_file(
            &"// GENERATED CODE -- DO NOT EDIT!\nfunction smtg(){}",
            &Language::TypeScript
        ));
    }
}
